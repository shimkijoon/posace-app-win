name: Build and Release MSIX

on:
  push:
    tags:
      - 'v*'  # v1.0.0 같은 태그 푸시 시 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Create MSIX package
        run: flutter pub run msix:create
      
      - name: Get version from pubspec
        id: version
        shell: pwsh
        run: |
          $version = (Get-Content pubspec.yaml | Select-String -Pattern "version:\s*(.+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/windows/x64/runner/Release/posace_app_win.msix
          name: POSAce Windows v${{ steps.version.outputs.VERSION }}
          body: |
            ## POSAce Windows POS Client
            
            ### 설치 방법
            1. `posace_app_win.msix` 다운로드
            2. 더블클릭하여 설치
            3. 백오피스에서 생성한 Device Token으로 로그인
            
            ### 변경사항
            - 프로덕션 API 서버 연결 (https://api.posace.com)
            - Supabase 인증 통합
            
            ### 시스템 요구사항
            - Windows 10/11
            - 인터넷 연결
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
