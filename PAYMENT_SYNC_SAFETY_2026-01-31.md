# ê²°ì œ ì¤‘ ë™ê¸°í™” ì•ˆì „ì„± ê°œì„ 

**ë‚ ì§œ**: 2026-01-31  
**ë¸Œëœì¹˜**: dev  
**ìƒíƒœ**: âœ… ì™„ë£Œ

## ğŸš¨ ë°œê²¬ëœ ë¬¸ì œì 

### ì›ë˜ êµ¬í˜„ì˜ ìœ„í—˜ ìš”ì†Œ

ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìë™ ë™ê¸°í™”ë¥¼ ì‹¤í–‰í•˜ë©´:

1. **ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ì†ì‹¤ ìœ„í—˜** âš ï¸
   - ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ìƒí’ˆì„ ë‹´ì•„ë†“ì€ ìƒíƒœ
   - ë™ê¸°í™” â†’ `_loadData()` â†’ ì¥ë°”êµ¬ë‹ˆ ì´ˆê¸°í™” ê°€ëŠ¥ì„±

2. **ê²°ì œ ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤** âš ï¸
   - ì„ íƒëœ í• ì¸ (`_selectedManualDiscountIds`)
   - ì„ íƒëœ ë©¤ë²„ (`_selectedMember`)
   - ê²°ì œ ê¸ˆì•¡, ê²°ì œ ë°©ë²• ë“±

3. **ì¤‘ë³µ ê²°ì œ ìœ„í—˜** âš ï¸
   - ì„œë²„ ì˜¤ë¥˜ (500) ë˜ëŠ” íƒ€ì„ì•„ì›ƒ
   - ê²°ì œëŠ” ì‹¤ì œë¡œ ì„±ê³µí–ˆëŠ”ë° ì‘ë‹µë§Œ ì‹¤íŒ¨
   - ì¬ì‹œë„ â†’ ì¤‘ë³µ ê²°ì œ ë°œìƒ

4. **ì‚¬ìš©ì í˜¼ë€** âš ï¸
   - ë™ê¸°í™” ì¤‘ ì–´ë–¤ ì •ë³´ê°€ ë³´ì¡´ë˜ëŠ”ì§€ ë¶ˆëª…í™•
   - ì§„í–‰ ìƒíƒœë¥¼ ì•Œ ìˆ˜ ì—†ìŒ

## âœ… ê°œì„  ë°©ì•ˆ

### 1. ì»¨í…ìŠ¤íŠ¸ ë³´ì¡´ ì‹œìŠ¤í…œ

#### PaymentContext í´ë˜ìŠ¤ ìƒì„±

```dart
class PaymentContext {
  final Cart cart;
  final Set<String> selectedDiscountIds;
  final CustomerMembershipModel? selectedMember;
  final double? customAmount;
  final String? paymentMethod;
  final String? tableId;
  
  // ì €ì¥/ë³µì› ê¸°ëŠ¥
  Map<String, dynamic> toJson();
  static PaymentContext fromJson(Map<String, dynamic> json);
}
```

### 2. ì•ˆì „í•œ ë™ê¸°í™” í”„ë¡œì„¸ìŠ¤

```dart
Future<void> _performAutoSync() async {
  // âœ… 1. í˜„ì¬ ìƒíƒœ ì €ì¥
  final savedCart = _cart;
  final savedDiscountIds = Set<String>.from(_selectedManualDiscountIds);
  final savedMember = _selectedMember;
  
  // âœ… 2. ì‚¬ìš©ì í™•ì¸ (ì¥ë°”êµ¬ë‹ˆê°€ ìˆëŠ” ê²½ìš°)
  if (savedCart.items.isNotEmpty) {
    final confirm = await showConfirmDialog();
    if (!confirm) return;
  }
  
  // âœ… 3. ë™ê¸°í™” ì‹¤í–‰
  await syncService.syncMaster(...);
  
  // âœ… 4. ë°ì´í„° ë¦¬ë¡œë“œ
  await _loadData();
  
  // âœ… 5. ì»¨í…ìŠ¤íŠ¸ ë³µì›
  setState(() {
    _cart = savedCart;
    _selectedManualDiscountIds = savedDiscountIds;
    _selectedMember = savedMember;
  });
}
```

### 3. ì¤‘ë³µ ê²°ì œ ë°©ì§€

```dart
// ì„œë²„ ì˜¤ë¥˜ë‚˜ íƒ€ì„ì•„ì›ƒì¼ ê²½ìš° ì¬ì‹œë„ ë²„íŠ¼ ë¹„í™œì„±í™”
final isDuplicateRisk = diagnosticError.statusCode >= 500 || 
                       diagnosticError.errorCode.code.contains('TIMEOUT');

await DiagnosticErrorDialog.show(
  context: context,
  error: diagnosticError,
  onRetryPressed: isDuplicateRisk ? null : () async {
    // ì¬ì‹œë„ ë¡œì§
  },
  systemInfo: {
    'isDuplicateRisk': isDuplicateRisk,
    'warning': isDuplicateRisk 
      ? 'ì„œë²„ ì˜¤ë¥˜: ê²°ì œê°€ ì‹¤ì œë¡œëŠ” ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŒ' 
      : null,
  },
);
```

### 4. ì‚¬ìš©ì í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸

```dart
AlertDialog(
  title: 'ë™ê¸°í™” í™•ì¸',
  content: Column(
    children: [
      Text('ë§ˆìŠ¤í„° ë°ì´í„°ë¥¼ ë™ê¸°í™”í•©ë‹ˆë‹¤.'),
      Container(
        child: Column(
          children: [
            Text('ğŸ“¦ í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ì •ë³´'),
            Text('â€¢ ìƒí’ˆ: ${savedCart.items.length}ê°œ'),
            Text('â€¢ ê¸ˆì•¡: â‚©${savedCart.total}'),
          ],
        ),
      ),
      Text('âœ… ì¥ë°”êµ¬ë‹ˆ ì •ë³´ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤'),
      Text('âœ… ë™ê¸°í™” í›„ ê²°ì œë¥¼ ê³„ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤'),
    ],
  ),
)
```

## ğŸ“Š ê°œì„  ì „í›„ ë¹„êµ

### Before (ìœ„í—˜)

```
ê²°ì œ ì‹œë„
   â†“
ì˜¤ë¥˜ ë°œìƒ (ìƒí’ˆ ì •ë³´ ì—†ìŒ)
   â†“
[ì§€ê¸ˆ ë™ê¸°í™”í•˜ê¸°] í´ë¦­
   â†“
ë™ê¸°í™” ì‹¤í–‰
   â†“
âŒ ì¥ë°”êµ¬ë‹ˆ 3ê°œ ìƒí’ˆ ì†ì‹¤
âŒ ì„ íƒí•œ í• ì¸ 2ê°œ ì†ì‹¤
âŒ ë©¤ë²„ ì •ë³´ ì†ì‹¤
   â†“
ë¹ˆ í™”ë©´... ì‚¬ìš©ì í˜¼ë€
```

### After (ì•ˆì „)

```
ê²°ì œ ì‹œë„
   â†“
ì˜¤ë¥˜ ë°œìƒ (ìƒí’ˆ ì •ë³´ ì—†ìŒ)
   â†“
[ì§€ê¸ˆ ë™ê¸°í™”í•˜ê¸°] í´ë¦­
   â†“
í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ì •ë³´     â”‚
â”‚ â€¢ ìƒí’ˆ: 3ê°œ              â”‚
â”‚ â€¢ ê¸ˆì•¡: â‚©45,000         â”‚
â”‚ â€¢ í• ì¸: 2ê°œ              â”‚
â”‚                          â”‚
â”‚ âœ… ì¥ë°”êµ¬ë‹ˆ ì •ë³´ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤ â”‚
â”‚ âœ… ë™ê¸°í™” í›„ ê²°ì œ ê³„ì† ê°€ëŠ¥  â”‚
â”‚                          â”‚
â”‚  [ì·¨ì†Œ]  [ë™ê¸°í™” ì‹¤í–‰]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
[ë™ê¸°í™” ì‹¤í–‰] í´ë¦­
   â†“
ğŸ’¾ ì¥ë°”êµ¬ë‹ˆ ì €ì¥: 3ê°œ
ğŸ’¾ í• ì¸ ì €ì¥: 2ê°œ
ğŸ’¾ ë©¤ë²„ ì €ì¥: member-id
   â†“
ë™ê¸°í™” ì‹¤í–‰...
   â†“
ğŸ”„ ì¥ë°”êµ¬ë‹ˆ ë³µì›: 3ê°œ
ğŸ”„ í• ì¸ ë³µì›: 2ê°œ
ğŸ”„ ë©¤ë²„ ë³µì›: member-id
   â†“
âœ… ëª¨ë“  ì •ë³´ ìœ ì§€!
âœ… ê²°ì œ ê³„ì† ê°€ëŠ¥!
```

## ğŸ›¡ï¸ ì•ˆì „ ì¥ì¹˜

### 1. ìƒíƒœ ë³´ì¡´
- âœ… Cart (_cart)
- âœ… ì„ íƒëœ í• ì¸ (_selectedManualDiscountIds)
- âœ… ì„ íƒëœ ë©¤ë²„ (_selectedMember)
- âœ… í…Œì´ë¸” ID (widget.tableId)

### 2. ì‚¬ìš©ì í™•ì¸
- âœ… ì¥ë°”êµ¬ë‹ˆê°€ ìˆì„ ë•Œë§Œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
- âœ… ì·¨ì†Œ ê°€ëŠ¥
- âœ… ëª…í™•í•œ ì •ë³´ ì œê³µ

### 3. ì¤‘ë³µ ê²°ì œ ë°©ì§€
- âœ… 500 ì˜¤ë¥˜ â†’ ì¬ì‹œë„ ë²„íŠ¼ ë¹„í™œì„±í™”
- âœ… íƒ€ì„ì•„ì›ƒ â†’ ì¬ì‹œë„ ë²„íŠ¼ ë¹„í™œì„±í™”
- âœ… ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ

### 4. ë’¤ë¡œê°€ê¸° ë°©ì§€
```dart
WillPopScope(
  onWillPop: () async => false, // ë™ê¸°í™” ì¤‘ ë’¤ë¡œê°€ê¸° ë§‰ê¸°
  child: LoadingDialog(...),
)
```

## ğŸ“ ì¶”ê°€ ì•ˆì „ ì¥ì¹˜ ì œì•ˆ

### 1. clientSaleId ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ (ì´ë¯¸ êµ¬í˜„ë¨)

```typescript
// server side
if (payload.clientSaleId) {
  const existing = await this.prisma.sale.findFirst({
    where: { clientSaleId: payload.clientSaleId },
  });
  if (existing) {
    return existing; // ì¤‘ë³µì´ë©´ ê¸°ì¡´ íŒë§¤ ë°˜í™˜
  }
}
```

### 2. ë¡œì»¬ ì„ì‹œ ì €ì¥ (ì„ íƒì‚¬í•­)

```dart
// ë™ê¸°í™” ì „ SharedPreferencesì— ì €ì¥
await _savePaymentContext();

// ë™ê¸°í™” í›„ ë³µì›
await _restorePaymentContext();
```

### 3. íŒë§¤ ë‚´ì—­ í™•ì¸ (ì„ íƒì‚¬í•­)

```dart
// ì¬ì‹œë„ ì „ ìµœê·¼ íŒë§¤ ë‚´ì—­ í™•ì¸
final recentSales = await salesApi.getRecentSales(
  storeId: storeId,
  limit: 10,
);

// ë™ì¼í•œ ê¸ˆì•¡, ì‹œê°„ì˜ íŒë§¤ê°€ ìˆëŠ”ì§€ ì²´í¬
final isDuplicate = recentSales.any((sale) =>
  sale.totalAmount == totalAmount &&
  sale.createdAt.difference(DateTime.now()).inMinutes < 5
);
```

## âœ… ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ìƒí’ˆ ì •ë³´ ì—†ìŒ (404)
1. âœ… ì¥ë°”êµ¬ë‹ˆ 3ê°œ ìƒí’ˆ ë‹´ê¸°
2. âœ… í• ì¸ 2ê°œ ì ìš©
3. âœ… ë©¤ë²„ ì„ íƒ
4. âœ… ê²°ì œ ì‹œë„ â†’ 404 ì˜¤ë¥˜
5. âœ… ë™ê¸°í™” ì‹¤í–‰
6. âœ… ì¥ë°”êµ¬ë‹ˆ/í• ì¸/ë©¤ë²„ ëª¨ë‘ ìœ ì§€
7. âœ… ê²°ì œ ì¬ì‹œë„ â†’ ì„±ê³µ

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì„œë²„ ì˜¤ë¥˜ (500)
1. âœ… ê²°ì œ ì‹œë„ â†’ 500 ì˜¤ë¥˜
2. âœ… ì—ëŸ¬ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
3. âœ… "ì¬ì‹œë„" ë²„íŠ¼ ë¹„í™œì„±í™” âš ï¸
4. âœ… ê²½ê³  ë©”ì‹œì§€: "ê²°ì œê°€ ì‹¤ì œë¡œëŠ” ì„±ê³µí–ˆì„ ìˆ˜ ìˆìŒ"
5. âœ… íŒë§¤ ë‚´ì—­ í™•ì¸ ê¶Œì¥

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë¹ˆ ì¥ë°”êµ¬ë‹ˆì—ì„œ ë™ê¸°í™”
1. âœ… ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ìˆìŒ
2. âœ… ë™ê¸°í™” ì‹¤í–‰
3. âœ… í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ìƒëµ (ë¶ˆí•„ìš”)
4. âœ… ë°”ë¡œ ë™ê¸°í™”

## ğŸ“š ì°¸ê³ 

### ê´€ë ¨ íŒŒì¼
- `lib/core/models/payment_context.dart` (ì‹ ê·œ)
- `lib/ui/sales/sales_page.dart` (_performAutoSync ê°œì„ )

### ê´€ë ¨ ì´ìŠˆ
- ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ì†ì‹¤ ë°©ì§€
- ì¤‘ë³µ ê²°ì œ ë°©ì§€
- ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

**ì‘ì„±ì**: AI Assistant  
**ê²€ì¦ì**: User (shimkijoon)
**ë¦¬ë·°ì–´**: User (shimkijoon) - ë¬¸ì œì  ë°œê²¬ ë° ê°œì„  ìš”ì²­
